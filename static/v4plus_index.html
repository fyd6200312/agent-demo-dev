<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent v4 - Web UI</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
:root {
  --bg-primary: #1a1b26;
  --bg-secondary: #1f2033;
  --bg-tertiary: #282a3a;
  --bg-hover: #32344a;
  --text-primary: #c0caf5;
  --text-secondary: #565f89;
  --text-muted: #414868;
  --accent: #7aa2f7;
  --accent-dim: #3d59a1;
  --green: #9ece6a;
  --orange: #e0af68;
  --red: #f7768e;
  --cyan: #7dcfff;
  --purple: #bb9af7;
  --border: #292e42;
  --radius: 8px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  overflow: hidden;
}
.container { display:flex; width:100%; height:100%; }

/* ===== Main Panel ===== */
.main-panel { flex:1; display:flex; flex-direction:column; min-width:0; }

.header {
  background: var(--bg-secondary);
  padding: 14px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.header h1 { font-size:16px; font-weight:600; letter-spacing:0.5px; }
.header h1 span { color: var(--accent); }
.status {
  display:flex; align-items:center; gap:8px;
  font-size:12px; color:var(--text-secondary);
}
.status-dot {
  width:8px; height:8px; border-radius:50%;
  background: var(--text-muted);
  transition: background 0.3s;
}
.status-dot.active {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%,100% { opacity:1; }
  50% { opacity:0.4; }
}

/* ===== Chat ===== */
.chat-area {
  flex:1; overflow-y:auto; padding:20px 24px;
  display:flex; flex-direction:column; gap:16px;
}
.chat-area::-webkit-scrollbar { width:6px; }
.chat-area::-webkit-scrollbar-track { background:transparent; }
.chat-area::-webkit-scrollbar-thumb { background:var(--bg-tertiary); border-radius:3px; }

.welcome {
  text-align:center; padding:60px 20px;
  color:var(--text-secondary);
}
.welcome h2 { font-size:20px; margin-bottom:8px; color:var(--text-primary); }
.welcome p { font-size:13px; }

/* Messages */
.msg { display:flex; flex-direction:column; gap:4px; max-width:85%; animation: fadeIn 0.2s ease; }
.msg.user { align-self:flex-end; }
.msg.assistant { align-self:flex-start; }
@keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

.msg-label {
  font-size:11px; color:var(--text-secondary);
  font-weight:600; text-transform:uppercase; letter-spacing:0.5px;
  padding: 0 4px;
}
.msg-body {
  padding:12px 16px; border-radius:var(--radius);
  line-height:1.65; font-size:14px;
  word-wrap:break-word; overflow-wrap:break-word;
}
.msg.user .msg-body {
  background: var(--accent-dim);
  color: #e0e7ff;
  border-bottom-right-radius: 2px;
}
.msg.assistant .msg-body {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-bottom-left-radius: 2px;
}
.msg.error .msg-body {
  background: rgba(247,118,142,0.1);
  border: 1px solid var(--red);
  color: var(--red);
}

/* Markdown inside messages */
.msg-body h1,.msg-body h2,.msg-body h3 { margin:12px 0 6px; }
.msg-body h1 { font-size:18px; }
.msg-body h2 { font-size:16px; }
.msg-body h3 { font-size:14px; }
.msg-body p { margin:6px 0; }
.msg-body ul,.msg-body ol { margin:6px 0; padding-left:20px; }
.msg-body li { margin:3px 0; }
.msg-body a { color:var(--accent); text-decoration:none; }
.msg-body a:hover { text-decoration:underline; }
.msg-body blockquote {
  border-left:3px solid var(--accent-dim); padding:4px 12px;
  margin:8px 0; color:var(--text-secondary);
}
.msg-body code {
  font-family:'JetBrains Mono','Fira Code','Cascadia Code',monospace;
  background:var(--bg-tertiary); padding:2px 6px; border-radius:4px; font-size:13px;
}
.msg-body pre {
  background:var(--bg-tertiary); padding:12px; border-radius:6px;
  overflow-x:auto; margin:8px 0; border:1px solid var(--border);
}
.msg-body pre code { background:none; padding:0; }
.msg-body table { border-collapse:collapse; margin:8px 0; width:100%; }
.msg-body th,.msg-body td { border:1px solid var(--border); padding:6px 10px; font-size:13px; }
.msg-body th { background:var(--bg-tertiary); }

/* ===== Tool Calls ===== */
.tool-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin: 6px 0;
  overflow: hidden;
  animation: fadeIn 0.2s ease;
  max-width: 85%;
}
.tool-header {
  padding: 8px 12px;
  display: flex; align-items:center;
  cursor: pointer; user-select:none;
  transition: background 0.15s;
  gap: 8px;
}
.tool-header:hover { background: var(--bg-hover); }
.tool-icon { font-size:12px; color:var(--text-secondary); transition:transform 0.2s; }
.tool-card.collapsed .tool-icon { transform:rotate(0deg); }
.tool-card:not(.collapsed) .tool-icon { transform:rotate(90deg); }
.tool-name {
  font-family:'JetBrains Mono','Fira Code',monospace;
  font-size:13px; font-weight:600; color:var(--cyan);
}
.tool-status {
  font-size:11px; margin-left:auto;
  padding:2px 8px; border-radius:10px;
}
.tool-status.running { background:rgba(224,175,104,0.15); color:var(--orange); }
.tool-status.done { background:rgba(158,206,106,0.15); color:var(--green); }
.tool-body {
  padding:10px 12px;
  border-top:1px solid var(--border);
  font-size:13px;
}
.tool-card.collapsed .tool-body { display:none; }
.tool-section-label {
  font-size:11px; color:var(--text-secondary);
  text-transform:uppercase; letter-spacing:0.5px;
  margin-bottom:4px; font-weight:600;
}
.tool-content {
  background:var(--bg-tertiary); padding:8px 10px;
  border-radius:4px; margin-bottom:8px;
  font-family:'JetBrains Mono','Fira Code',monospace;
  font-size:12px; line-height:1.5;
  white-space:pre-wrap; word-wrap:break-word; word-break:break-word;
  overflow-y:auto; overflow-x:hidden;
}
.tool-content.tool-input { max-height:100px; }
.tool-content.tool-output { max-height:200px; }

/* ===== Subagent ===== */
.subagent-card {
  background: var(--bg-secondary);
  border-left: 3px solid var(--purple);
  border-radius: 0 var(--radius) var(--radius) 0;
  padding: 10px 14px;
  margin: 6px 0;
  animation: fadeIn 0.2s ease;
  max-width: 85%;
}
.subagent-top {
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.subagent-type {
  font-weight:700; color:var(--purple); font-size:13px;
}
.subagent-desc { font-size:13px; color:var(--text-primary); }
.subagent-skill-tag {
  font-size:10px; background:rgba(187,154,247,0.15);
  color:var(--purple); padding:2px 8px; border-radius:10px;
}
.subagent-progress {
  font-size:12px; color:var(--text-secondary);
  font-family:monospace; margin-top:6px;
}
.subagent-result {
  margin-top:8px; padding:8px 10px;
  background:var(--bg-tertiary); border-radius:4px;
  font-size:13px; line-height:1.5;
  max-height:200px; overflow-y:auto;
}

/* ===== Input ===== */
.input-area {
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  padding: 14px 24px;
  display: flex; gap:12px; align-items:flex-end;
  flex-shrink: 0;
}
#userInput {
  flex:1; background:var(--bg-tertiary);
  border:1px solid var(--border); color:var(--text-primary);
  padding:10px 14px; border-radius:var(--radius);
  font-size:14px; font-family:inherit;
  resize:none; min-height:42px; max-height:160px;
  line-height:1.5;
  transition: border-color 0.2s;
}
#userInput:focus { outline:none; border-color:var(--accent); }
#userInput::placeholder { color:var(--text-muted); }
#sendBtn {
  background:var(--accent); color:#fff; border:none;
  padding:10px 20px; border-radius:var(--radius);
  font-size:14px; font-weight:600; cursor:pointer;
  transition: background 0.2s, opacity 0.2s;
  white-space:nowrap;
}
#sendBtn:hover:not(:disabled) { background:#5b8af7; }
#sendBtn:disabled { opacity:0.4; cursor:not-allowed; }

/* ===== Sidebar ===== */
.sidebar {
  width:280px; background:var(--bg-secondary);
  border-left:1px solid var(--border);
  display:flex; flex-direction:column;
  flex-shrink:0;
}
.sidebar-section {
  display:flex; flex-direction:column;
}
.sidebar-title {
  padding:14px 16px; font-size:12px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.8px;
  color:var(--text-secondary);
  border-bottom:1px solid var(--border);
}
.todo-list {
  flex:1; overflow-y:auto; padding:10px;
}
.todo-empty {
  text-align:center; padding:30px 16px;
  color:var(--text-muted); font-size:13px;
}
.todo-item {
  padding:8px 10px; margin-bottom:6px;
  background:var(--bg-tertiary); border-radius:6px;
  display:flex; align-items:flex-start; gap:8px;
  font-size:13px; line-height:1.4;
}
.todo-icon { flex-shrink:0; margin-top:1px; font-size:14px; }
.todo-item.completed { opacity:0.5; }
.todo-item.completed .todo-text { text-decoration:line-through; }
.todo-item.in_progress { border-left:3px solid var(--accent); }
.todo-text { flex:1; }

.skills-list { padding:10px; overflow-y:auto; }
.skill-item {
  padding:8px 10px; margin-bottom:6px;
  background:var(--bg-tertiary); border-radius:6px;
  font-size:12px;
}
.skill-item-name { font-weight:700; color:var(--green); }
.skill-item-desc { color:var(--text-secondary); margin-top:2px; }

/* ===== Responsive ===== */
@media (max-width:768px) {
  .sidebar { display:none; }
  .msg { max-width:95%; }
  .tool-card,.subagent-card { max-width:95%; }
}

/* ===== Typing Indicator ===== */
.typing-indicator {
  display:flex; align-items:center; gap:4px;
  padding:12px 16px; align-self:flex-start;
}
.typing-indicator span {
  width:8px; height:8px; border-radius:50%;
  background:var(--text-muted);
  animation: typingBounce 1.2s infinite;
}
.typing-indicator span:nth-child(2) { animation-delay:0.2s; }
.typing-indicator span:nth-child(3) { animation-delay:0.4s; }
@keyframes typingBounce {
  0%,60%,100% { transform:translateY(0); opacity:0.4; }
  30% { transform:translateY(-6px); opacity:1; }
}
</style>
</head>
<body>
<div class="container">
  <div class="main-panel">
    <div class="header">
      <h1><span>Agent</span> v4</h1>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Ready</span>
      </div>
    </div>

    <div class="chat-area" id="chat">
      <div class="welcome" id="welcome">
        <h2>Agent v4</h2>
        <p>Specialist Team Pattern ‚Äî ËæìÂÖ•Ê∂àÊÅØÂºÄÂßãÂØπËØù</p>
      </div>
    </div>

    <div class="input-area">
      <textarea id="userInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Enter ÂèëÈÄÅ, Shift+Enter Êç¢Ë°å)" rows="1"></textarea>
      <button id="sendBtn">ÂèëÈÄÅ</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="sidebar-title">Todo List</div>
      <div class="todo-list" id="todoList">
        <div class="todo-empty">ÊöÇÊó†‰ªªÂä°</div>
      </div>
    </div>
    <div class="sidebar-section" style="max-height:40%;border-top:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;">
      <div class="sidebar-title">Skills</div>
      <div class="skills-list" id="skillsList"></div>
    </div>
  </div>
</div>

<script>
// ===== State =====
let processing = false;

const chat = document.getElementById('chat');
const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const todoList = document.getElementById('todoList');
const skillsList = document.getElementById('skillsList');
let welcome = document.getElementById('welcome');

// ===== Marked config =====
marked.setOptions({
  breaks: true,
});

function highlightCodeBlocks(container) {
  const blocks = container.querySelectorAll('pre code');
  if (blocks.length > 20) return;
  blocks.forEach(el => {
    if (el.textContent.length < 5000) hljs.highlightElement(el);
  });
}

// ===== Init =====
loadSkills();

// ===== Events =====
sendBtn.addEventListener('click', send);
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 160) + 'px';
});

// ===== Send =====
async function send() {
  const text = input.value.trim();
  if (!text || processing) return;

  if (welcome) { welcome.remove(); welcome = null; }
  input.value = '';
  input.style.height = 'auto';

  addMsg('user', text);
  setStatus(true);
  showTypingIndicator();

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: text}),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.error) {
      addMsg('error', data.error);
      setStatus(false);
      return;
    }
    startSSE();
  } catch(e) {
    addMsg('error', e.message);
    setStatus(false);
  }
}

// ===== SSE =====
async function startSSE() {
  try {
    const res = await fetch('/api/chat/stream');
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, {stream: true});
      const lines = buffer.split('\n');
      buffer = lines.pop(); // keep incomplete line

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const ev = JSON.parse(line.slice(6));
            handleEvent(ev);
            if (ev.type === 'done') {
              reader.cancel();
              return;
            }
          } catch(err) { console.error('Parse error:', err); }
        }
      }
    }
  } catch(e) {
    console.error('SSE error:', e);
  } finally {
    setStatus(false);
  }
}

function handleEvent(ev) {
  removeTypingIndicator();
  switch(ev.type) {
    case 'message': addMsg('assistant', ev.content); break;
    case 'tool_call': addToolCall(ev.tool, ev.input); break;
    case 'tool_result': updateToolResult(ev.tool, ev.output); break;
    case 'subagent_start': addSubagent(ev.agent_type, ev.description, ev.skills); break;
    case 'subagent_progress': updateSubagentProgress(ev.description, ev.tool_count, ev.elapsed); break;
    case 'subagent_complete': completeSubagent(ev.description, ev.result); break;
    case 'todo_update': renderTodos(ev.todos); break;
    case 'error': addMsg('error', ev.message); break;
    case 'done':
      setStatus(false);
      break;
  }
}

// ===== UI Helpers =====
function setStatus(active) {
  processing = active;
  sendBtn.disabled = active;
  statusDot.classList.toggle('active', active);
  statusText.textContent = active ? 'Processing...' : 'Ready';
}

function isNearBottom() {
  return chat.scrollHeight - chat.scrollTop - chat.clientHeight < 150;
}

function scrollBottom() {
  if (isNearBottom()) {
    requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
  }
}

function forceScrollBottom() {
  requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function truncateText(s, max) {
  if (!s || s.length <= max) return s;
  return s.slice(0, max) + '\n... (truncated, ' + s.length + ' chars total)';
}

function renderMd(text) {
  try { return marked.parse(text); }
  catch(e) { return escapeHtml(text); }
}

// ===== Typing Indicator =====
function showTypingIndicator() {
  removeTypingIndicator();
  const el = document.createElement('div');
  el.className = 'typing-indicator';
  el.id = 'typingIndicator';
  el.innerHTML = '<span></span><span></span><span></span>';
  chat.appendChild(el);
  forceScrollBottom();
}

function removeTypingIndicator() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

// ===== Messages =====
function addMsg(role, content) {
  removeTypingIndicator();

  const div = document.createElement('div');
  div.className = `msg ${role}`;

  const label = document.createElement('div');
  label.className = 'msg-label';
  label.textContent = role === 'user' ? 'You' : role === 'assistant' ? 'Assistant' : 'Error';

  const body = document.createElement('div');
  body.className = 'msg-body';
  if (role === 'assistant') {
    body.innerHTML = renderMd(content);
    highlightCodeBlocks(body);
  } else {
    body.textContent = content;
  }

  div.appendChild(label);
  div.appendChild(body);
  chat.appendChild(div);
  if (role === 'user') forceScrollBottom();
  else scrollBottom();
}

// ===== Tool Calls =====
let toolCardCounter = 0;
const toolDataStore = {}; // Store raw data, render only on expand

function addToolCall(name, inp) {
  const id = 'tool-' + (++toolCardCounter);

  // Store raw data
  toolDataStore[id] = {
    name: name,
    input: truncateText(JSON.stringify(inp, null, 2), 500),
    output: null, // filled later
  };

  const card = document.createElement('div');
  card.className = 'tool-card collapsed';
  card.id = id;
  card.dataset.tool = name;

  // Summarize input for header
  let summary = '';
  if (name === 'bash') summary = inp.command || '';
  else if (name === 'read_file') summary = inp.path || '';
  else if (name === 'write_file') summary = inp.path || '';
  else if (name === 'edit_file') summary = inp.path || '';
  else if (name === 'Task') summary = inp.description || '';
  else if (name === 'Skill') summary = inp.skill || '';
  if (summary.length > 60) summary = summary.slice(0, 57) + '...';

  // Only render header ‚Äî body is empty until expanded
  card.innerHTML = `
    <div class="tool-header">
      <span class="tool-icon">‚ñ∂</span>
      <span class="tool-name">${escapeHtml(name)}</span>
      <span style="font-size:12px;color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(summary)}</span>
      <span class="tool-status running">running</span>
    </div>
    <div class="tool-body"></div>
  `;
  card.querySelector('.tool-header').addEventListener('click', () => toggleToolCard(id));
  chat.appendChild(card);
  scrollBottom();
}

function toggleToolCard(id) {
  const card = document.getElementById(id);
  if (!card) return;
  const isCollapsed = card.classList.contains('collapsed');
  if (isCollapsed) {
    // Expand: render body content from stored data
    const data = toolDataStore[id];
    if (data) {
      const body = card.querySelector('.tool-body');
      body.innerHTML = '';
      const inputLabel = document.createElement('div');
      inputLabel.className = 'tool-section-label';
      inputLabel.textContent = 'Input';
      const inputContent = document.createElement('div');
      inputContent.className = 'tool-content tool-input';
      inputContent.textContent = data.input;
      const outputLabel = document.createElement('div');
      outputLabel.className = 'tool-section-label';
      outputLabel.textContent = 'Output';
      const outputContent = document.createElement('div');
      outputContent.className = 'tool-content tool-output';
      outputContent.textContent = data.output || '‚è≥ ÊâßË°å‰∏≠...';
      body.appendChild(inputLabel);
      body.appendChild(inputContent);
      body.appendChild(outputLabel);
      body.appendChild(outputContent);
    }
    card.classList.remove('collapsed');
  } else {
    // Collapse: destroy body content to free DOM
    card.querySelector('.tool-body').innerHTML = '';
    card.classList.add('collapsed');
  }
}

function updateToolResult(name, output) {
  const cards = chat.querySelectorAll(`.tool-card[data-tool="${CSS.escape(name)}"]`);
  for (let i = cards.length - 1; i >= 0; i--) {
    const status = cards[i].querySelector('.tool-status');
    if (status && status.classList.contains('running')) {
      status.textContent = 'done';
      status.classList.remove('running');
      status.classList.add('done');
      // Store truncated output in JS, NOT in DOM
      const id = cards[i].id;
      if (toolDataStore[id]) {
        toolDataStore[id].output = truncateText(output, 1500);
      }
      // Ensure collapsed (body is already empty)
      cards[i].classList.add('collapsed');
      cards[i].querySelector('.tool-body').innerHTML = '';
      break;
    }
  }
  scrollBottom();
}

// formatTerminalOutput removed ‚Äî all tool output uses plain textContent now

// ===== Subagents =====
let subagentCounter = 0;
const subagentDataStore = {};

function addSubagent(agentType, desc, skills) {
  const id = 'sub-' + (++subagentCounter);
  subagentDataStore[id] = { result: null };

  const card = document.createElement('div');
  card.className = 'subagent-card';
  card.id = id;
  card.dataset.desc = desc;

  const skillTags = (skills || []).map(s =>
    `<span class="subagent-skill-tag">${escapeHtml(s)}</span>`
  ).join(' ');

  card.innerHTML = `
    <div class="subagent-top">
      <span class="subagent-type">[${escapeHtml(agentType)}]</span>
      <span class="subagent-desc">${escapeHtml(desc)}</span>
      ${skillTags}
    </div>
    <div class="subagent-progress">ÂêØÂä®‰∏≠...</div>
  `;
  chat.appendChild(card);
  scrollBottom();
}

function updateSubagentProgress(desc, toolCount, elapsed) {
  const cards = chat.querySelectorAll('.subagent-card');
  for (let i = cards.length - 1; i >= 0; i--) {
    if (cards[i].dataset.desc === desc && !cards[i].classList.contains('done')) {
      cards[i].querySelector('.subagent-progress').textContent =
        `${toolCount} tools, ${elapsed}s`;
      break;
    }
  }
}

function completeSubagent(desc, result) {
  const cards = chat.querySelectorAll('.subagent-card');
  for (let i = cards.length - 1; i >= 0; i--) {
    if (cards[i].dataset.desc === desc && !cards[i].classList.contains('done')) {
      cards[i].classList.add('done');
      cards[i].querySelector('.subagent-progress').innerHTML =
        '<span style="color:var(--green)">‚úì ÂÆåÊàê</span>';
      // Store result in JS, render a summary only
      const id = cards[i].id;
      const truncated = truncateText(result, 2000);
      if (subagentDataStore[id]) {
        subagentDataStore[id].result = truncated;
      }
      // Show a clickable summary instead of full content
      const resDiv = document.createElement('div');
      resDiv.className = 'subagent-result-toggle';
      resDiv.textContent = 'ÁÇπÂáªÊü•ÁúãÁªìÊûú ‚ñ∏';
      resDiv.style.cssText = 'font-size:12px;color:var(--purple);cursor:pointer;margin-top:6px;';
      const resultContainer = document.createElement('div');
      resultContainer.className = 'subagent-result';
      resultContainer.style.display = 'none';
      resDiv.addEventListener('click', () => {
        if (resultContainer.style.display === 'none') {
          resultContainer.style.display = 'block';
          resultContainer.innerHTML = renderMd(subagentDataStore[id]?.result || '');
          highlightCodeBlocks(resultContainer);
          resDiv.textContent = 'Êî∂Ëµ∑ÁªìÊûú ‚ñæ';
        } else {
          resultContainer.style.display = 'none';
          resultContainer.innerHTML = '';
          resDiv.textContent = 'ÁÇπÂáªÊü•ÁúãÁªìÊûú ‚ñ∏';
        }
      });
      cards[i].appendChild(resDiv);
      cards[i].appendChild(resultContainer);
      break;
    }
  }
  scrollBottom();
}

// ===== Todo List =====
function renderTodos(todos) {
  if (!todos || todos.length === 0) {
    todoList.innerHTML = '<div class="todo-empty">ÊöÇÊó†‰ªªÂä°</div>';
    return;
  }
  todoList.innerHTML = todos.map(t => {
    const icon = t.status === 'completed' ? '‚úÖ' :
                 t.status === 'in_progress' ? 'üîÑ' : '‚¨ú';
    return `<div class="todo-item ${t.status}">
      <span class="todo-icon">${icon}</span>
      <span class="todo-text">${escapeHtml(t.content)}</span>
    </div>`;
  }).join('');
}

// ===== Skills =====
async function loadSkills() {
  try {
    const res = await fetch('/api/skills');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.length === 0) {
      skillsList.innerHTML = '<div class="todo-empty">Êó†ÂèØÁî® Skills</div>';
      return;
    }
    skillsList.innerHTML = data.map(s =>
      `<div class="skill-item">
        <div class="skill-item-name">${escapeHtml(s.name)}</div>
        <div class="skill-item-desc">${escapeHtml(s.description)}</div>
      </div>`
    ).join('');
  } catch(e) {
    skillsList.innerHTML = '<div class="todo-empty">Âä†ËΩΩÂ§±Ë¥•</div>';
  }
}
</script>
</body>
</html>
